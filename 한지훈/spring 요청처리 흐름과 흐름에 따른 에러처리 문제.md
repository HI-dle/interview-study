# spring 요청 흐름


외부 요청에 따라 내부적으로 어떤 흐름을 거치고 각 요청에 대한 범위 목적에 대해 정리하고자 한다.

 

외부 요청에 따라 크게 필터, 인터셉터, 디스패처 서블릿, AOP, 컨트롤러가 어느 흐름과 목적을 가지는지 정리하자.
![image](https://github.com/user-attachments/assets/770378ea-beeb-42cf-9501-9d1d9a602875)

Filter - 필터는 요청과 반환 맨 앞 단에 존재한다. 필터는 스프링의 기능이 아닌 자바 서블릿의 기능이다.

Filter Chain을 통한 연쇄 기능을 동작하게 할 수 있다. 서블릿 컨테이너가 관리하며 WAS가 관리하게 된다. HTTP 요청을 가로채 기능하며 인증, 로깅 CORS 처리 등을 한다.

 

Dispatcher Servlet - 여기서부터는 spring context 내부이다.

Interceptor, Controller, ExceptionResolver, ViewResolver등이 실행되며 controller를 찾아 매핑해 사용자 요청에 맞는 view, json을 반환해 주는 역할을 한다.

 

interceptor - HandlerInterceptor로 스프링에서 사용되며 컨트롤러 전 후에 동작한다. 인증, 접근 권한 검사, 로깅에 사용되며 컨트롤러 호출 전에는 preHandle, 컨트롤러 실행 후에는 postHandle 메서드를 통해서 동작하게 된다.

 

AOP - 빈 내부에서 프록시를 통해 동작하게 된다. 각 계층에 대해 횡단 관심사에 대해 정의한 공통된 동작을 실행하게 된다. 트랜잭션, 로깅 등에 보통 사용되고 사용자 요청 흐름에 대한 부분은 아니며 내부적인 기능에 대한 흐름의 일부이다. 스프링 컨텍스트 내부의 빈 메서드에 대해 적용 범위가 한정된다.

 ---

위 흐름을 알지 못하고 발생한 문제점 -> 필터에서 발생한 예외를 spring context 내부 로직으로 예외를 처리하려 하거나 spring context 내부 예외를 필터에서 해결해 줄 수 없는 것에 대해 각 다른 계층에서 발생한 예외를 다른 계층에서 처리하려 할 때 처리되지 않는 문제.

 

security나 별도의 filter를 구성한 로직에서 filter에서 발생한 예외는 securitychainfilter나 별도의 필터 예외 로직을 통해 해결해야 한다. spring context 내부에서 발생하는 예외는 별도로 잡아서 처리하거나 던져서 처리하게 되는데 RestControllerAdvice나 ControllerAdvice를 통한 글로벌 예외 처리 로직을 구성해서 처리해야 한다.

 

## 의문점

스프링 컨텍스트 내부의 예외가 반환되는 필터까지 던져지거나 필터에서 잡을 수 있나?

-> 기본적으로는 스프링 컨텍스트 내부의 예외가 필터부까지 던져질 수 없다. 하지만 명시적으로 던지거나 필터 체인 흐름상 처리 흐름을 제어는 할 수 있다.

controller에서 예외를 던지고 filter에서 chain 형식으로 호출한 dispatcher servlet에서 try-catch를 통해 잡을 수 있지만 이미 응답된 spring은 커밋된 상태이기 때문에 조작은 할 수 없다.

 

 

## 마무리

스프링 시큐리티에서 예외처리를 하면 필터부인 서블릿에서 예외 처리를 담당하게 되는거고 실제 서비스 코드 내부에서 인증이나 인가 예외가 별도로 발생한다면 둘이 발생하는 지점이 다른 것이고 만약 필터에서 예외가 발생하고 필터에서 처리를 한다면 서블릿 내부에서 처리 되는 거고 만약 서비스 내부에서 발생한 예외를 글로벌 예외 핸들러를 구성해서 만든다면 예외 핸들러가 잡아서 처리하는 것이다.
